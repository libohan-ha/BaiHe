# 百合文学档案馆 - 学习笔记

## 后端入口文件 app.js 学习

**文件位置**: [`test/backend/src/app.js`](test/backend/src/app.js)

### 1. 静态文件服务
```javascript
app.use('/uploads', express.static(path.join(__dirname, '../uploads')));
```
- 当访问路径是 `/uploads` 时，去当前目录的上级目录的 `uploads` 路径下访问图片
- 例如：`http://localhost:3000/uploads/avatars/abc.jpg` → 实际文件 `test/backend/uploads/avatars/abc.jpg`

### 2. 环境变量加载
```javascript
require('dotenv').config();
```
- `dotenv` 的作用是读取 `.env` 文件中的环境变量
- 加载后可通过 `process.env.PORT` 等方式访问

### 3. HTTP 请求日志
```javascript
const morgan = require('morgan');
app.use(morgan('dev'));
```
- `morgan` 是打印 HTTP 请求日志的中间件
- 控制台会输出：`GET /api/articles 200 12.345 ms`

### 4. 模块导入
- 导入了各种路由模块：`auth.routes`、`user.routes`、`article.routes` 等
- 导入了中间件：`errorHandler`
- 导入了配置：`multer`（文件上传）

### 5. 路由转发
```javascript
app.use('/api/auth', authRoutes);
app.use('/api/users', userRoutes);
app.use('/api/articles', articleRoutes);
// ... 更多路由
```
- 当某个请求过来时，根据路径前缀转发到对应的 routes 方法中
- 例如：`POST /api/auth/login` 会转发到 `authRoutes` 处理

### 6. 跨域配置
```javascript
app.use(cors({
  origin: process.env.CORS_ORIGIN || true,  // 允许所有来源（开发环境）
  credentials: true
}));
```
- 配置跨域请求，允许所有来源访问
- `credentials: true` 允许携带 Cookie

---

## 管理员路由 admin.routes.js 学习

**文件位置**: [`test/backend/src/routes/admin.routes.js`](test/backend/src/routes/admin.routes.js)

### 1. 这是管理员功能的接口

管理员路由分为两个权限级别：
- **`adminAuth`** - 普通管理员权限
- **`superAdminAuth`** - 超级管理员权限

### 2. 超级管理员专属接口

```javascript
router.get('/', ...superAdminAuth, getAdmins);      // 获取所有管理员
router.post('/', ...superAdminAuth, createAdmin);   // 创建管理员
router.put('/:id', ...superAdminAuth, updateAdmin); // 更新管理员
router.delete('/:id', ...superAdminAuth, deleteAdmin); // 删除管理员
```
- 当请求是 `/`，必须经过**超级管理员认证**，才能获取/创建/更新/删除管理员

### 3. 普通管理员接口

```javascript
// 用户管理
router.get('/users', ...adminAuth, adminPanelController.getUsers);
router.put('/users/:id/role', ...adminAuth, adminPanelController.updateUserRole);
router.delete('/users/:id', ...adminAuth, adminPanelController.deleteUser);

// 文章管理
router.get('/articles', ...adminAuth, adminPanelController.getArticles);
router.put('/articles/:id/status', ...adminAuth, adminPanelController.updateArticleStatus);
router.delete('/articles/:id', ...adminAuth, adminPanelController.deleteArticle);

// 图片管理
router.get('/images', ...adminAuth, imageController.getAllImages);
router.delete('/images/:id', ...adminAuth, imageController.adminDeleteImage);
```
- 请求为 `/users`、`/articles`、`/images` 时，经过**普通管理员认证**即可
- 功能包括：增删改查文章、改变用户角色、删除图片等

### 4. 路由模式总结

```
请求 → 认证中间件 → 控制器方法
         ↓
    验证权限失败 → 返回 401/403
    验证权限成功 → 执行业务逻辑
```

---

## 学习进度

- [x] 后端入口文件 app.js
- [x] 管理员路由 admin.routes.js
- [ ] 数据库模型 schema.prisma
- [ ] 认证服务 auth.service.js
- [ ] 前端入口 App.tsx