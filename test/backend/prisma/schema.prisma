generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  USER
  ADMIN
  SUPER_ADMIN
}

enum ArticleStatus {
  DRAFT
  PUBLISHED
}

model User {
  id                        String                   @id @default(cuid())
  email                     String                   @unique
  username                  String                   @unique
  password                  String
  avatarUrl                 String?
  bio                       String?
  role                      UserRole                 @default(USER)
  articles                  Article[]
  collections               Collection[]
  comments                  Comment[]
  images                    Image[]
  imageCollections          ImageCollection[]
  aiCharacters              AICharacter[]
  conversations             Conversation[]
  // 隐私相册相关
  privateImages             PrivateImage[]
  privateImageCollections   PrivateImageCollection[]
  // 公共聊天室相关
  publicChatMessages        PublicChatMessage[]
  createdAt                 DateTime                 @default(now())
  updatedAt                 DateTime                 @updatedAt

  @@index([email])
  @@index([username])
}

model Article {
  id          String        @id @default(cuid())
  title       String
  summary     String?
  content     String
  coverUrl    String?
  authorId    String
  author      User          @relation(fields: [authorId], references: [id], onDelete: Cascade)
  views       Int           @default(0)
  status      ArticleStatus @default(PUBLISHED)
  tags        Tag[]
  collections Collection[]
  comments    Comment[]
  createdAt   DateTime      @default(now())
  updatedAt   DateTime      @updatedAt

  @@index([authorId])
  @@index([status])
  @@index([createdAt])
}

model Tag {
  id        String    @id @default(cuid())
  name      String    @unique
  articles  Article[]
  createdAt DateTime  @default(now())

  @@index([name])
}

model Collection {
  id        String   @id @default(cuid())
  userId    String
  articleId String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  article   Article  @relation(fields: [articleId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, articleId])
  @@index([userId])
  @@index([articleId])
}

model Comment {
  id        String   @id @default(cuid())
  content   String
  articleId String?
  imageId   String?
  userId    String
  parentId  String?
  article   Article? @relation(fields: [articleId], references: [id], onDelete: Cascade)
  image     Image?   @relation(fields: [imageId], references: [id], onDelete: Cascade)
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  parent    Comment? @relation("CommentReplies", fields: [parentId], references: [id], onDelete: Cascade)
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now())

  @@index([articleId])
  @@index([imageId])
  @@index([userId])
  @@index([parentId])
}

model Image {
  id           String            @id @default(cuid())
  title        String
  description  String?
  url          String
  thumbnailUrl String?
  width        Int?
  height       Int?
  size         Int               @default(0)
  uploaderId   String
  uploader     User              @relation(fields: [uploaderId], references: [id], onDelete: Cascade)
  tags         ImageTag[]
  collections  ImageCollection[]
  comments     Comment[]
  views        Int               @default(0)
  createdAt    DateTime          @default(now())
  updatedAt    DateTime          @updatedAt

  @@index([uploaderId])
  @@index([createdAt])
}

model ImageTag {
  id        String   @id @default(cuid())
  name      String   @unique
  images    Image[]
  createdAt DateTime @default(now())

  @@index([name])
}

model ImageCollection {
  id        String   @id @default(cuid())
  userId    String
  imageId   String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  image     Image    @relation(fields: [imageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, imageId])
  @@index([userId])
  @@index([imageId])
}

// ============ AI聊天相关模型 ============

model AICharacter {
  id                   String               @id @default(cuid())
  name                 String               // 角色名称
  avatarUrl            String?              // 角色头像
  userAvatarUrl        String?              // 用户在此角色下显示的头像
  prompt               String               @db.Text // 角色提示词
  backgroundUrl        String?              // 聊天背景图片
  modelName            String               @default("deepseek-chat") // 使用的模型名称
  bubbleOpacity        Int                  @default(85) // 消息气泡透明度 (0-100)
  userId               String               // 创建者ID
  user                 User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  conversations        Conversation[]
  publicChatMessages   PublicChatMessage[]  // 公共聊天室中该AI的消息
  conversationMembers  ConversationMember[] // 参与的群聊
  chatMessages         ChatMessage[]        // 群聊中发送的消息
  createdAt            DateTime             @default(now())
  updatedAt            DateTime             @updatedAt

  @@index([userId])
}

model Conversation {
  id            String               @id @default(cuid())
  title         String               @default("新对话") // 对话标题
  backgroundUrl String?              // 群聊背景图片
  characterId   String?              // 一对一聊天时的AI角色ID（群聊时为空）
  character     AICharacter?         @relation(fields: [characterId], references: [id], onDelete: Cascade)
  userId        String
  user          User                 @relation(fields: [userId], references: [id], onDelete: Cascade)
  isGroupChat   Boolean              @default(false) // 是否为群聊
  messages      ChatMessage[]
  members       ConversationMember[] // 群聊成员
  createdAt     DateTime             @default(now())
  updatedAt     DateTime             @updatedAt

  @@index([characterId])
  @@index([userId])
  @@index([isGroupChat])
}

model ChatMessage {
  id             String       @id @default(cuid())
  content        String       @db.Text // 消息内容
  role           String       // 'user' 或 'assistant'
  images         String[]     // 用户上传的图片URL数组
  aiCharacterId  String?      // AI角色ID（群聊时标识是哪个AI的回复）
  aiCharacter    AICharacter? @relation(fields: [aiCharacterId], references: [id], onDelete: SetNull)
  conversationId String
  conversation   Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  createdAt      DateTime     @default(now())

  @@index([conversationId])
  @@index([aiCharacterId])
}

// ============ 隐私相册相关模型 ============

model PrivateImage {
  id           String                   @id @default(cuid())
  title        String                   // 图片标题
  description  String?                  // 图片描述
  url          String                   // 图片URL
  thumbnailUrl String?                  // 缩略图URL
  width        Int?                     // 图片宽度
  height       Int?                     // 图片高度
  size         Int                      @default(0) // 文件大小(字节)
  ownerId      String                   // 所有者ID（只有所有者可以访问）
  owner        User                     @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  tags         PrivateImageTag[]        // 隐私图片标签
  collections  PrivateImageCollection[] // 收藏记录
  createdAt    DateTime                 @default(now())
  updatedAt    DateTime                 @updatedAt

  @@index([ownerId])
  @@index([createdAt])
}

model PrivateImageTag {
  id        String         @id @default(cuid())
  name      String         @unique // 标签名称全局唯一
  images    PrivateImage[]
  createdAt DateTime       @default(now())

  @@index([name])
}

model PrivateImageCollection {
  id        String       @id @default(cuid())
  userId    String       // 收藏者ID
  imageId   String       // 隐私图片ID
  user      User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  image     PrivateImage @relation(fields: [imageId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, imageId]) // 同一用户不能重复收藏同一图片
  @@index([userId])
  @@index([imageId])
}

// ============ 公共聊天室相关模型 ============

model PublicChatMessage {
  id              String        @id @default(cuid())
  content         String        @db.Text           // 消息内容
  imageUrl        String?                          // 图片URL（可选）
  userId          String?                          // 用户ID（AI消息时为空）
  user            User?         @relation(fields: [userId], references: [id], onDelete: Cascade)
  aiCharacterId   String?                          // AI角色ID（用户消息时为空）
  aiCharacter     AICharacter?  @relation(fields: [aiCharacterId], references: [id], onDelete: SetNull)
  createdAt       DateTime      @default(now())

  @@index([createdAt])
  @@index([userId])
  @@index([aiCharacterId])
}

// ============ 群聊成员关联模型 ============

model ConversationMember {
  id              String       @id @default(cuid())
  conversationId  String
  conversation    Conversation @relation(fields: [conversationId], references: [id], onDelete: Cascade)
  aiCharacterId   String
  aiCharacter     AICharacter  @relation(fields: [aiCharacterId], references: [id], onDelete: Cascade)
  order           Int          @default(0) // 成员顺序（用于回复排序）
  createdAt       DateTime     @default(now())

  @@unique([conversationId, aiCharacterId]) // 同一对话不能重复添加同一AI
  @@index([conversationId])
  @@index([aiCharacterId])
}
